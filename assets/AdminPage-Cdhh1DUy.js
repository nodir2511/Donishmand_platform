import{e as X,u as de,c as me,r as l,s as m,j as e,L as b,C as ue,X as V,h as C,S as G,B as xe,U as ge,k as he}from"./index-DRfO7QNx.js";import{u as pe}from"./useDebounce-tfDXdiEZ.js";import{U as M}from"./user-plus-BsT-pAi8.js";import{C as be}from"./chevron-left-DH9hOaJo.js";import{E as fe}from"./eye-off-DyCTa7pX.js";import{E as je}from"./eye-DijbaegS.js";import{S as ve,a as we,b as ye}from"./shield-DwlyXhVX.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=X("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=X("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),Ae=()=>{const{t:ke,i18n:Z}=de(),z=Z.resolvedLanguage||"ru",{isSuperAdmin:f,profile:j}=me(),[E,v]=l.useState([]),[w,U]=l.useState(!0),[P,H]=l.useState(""),[u,y]=l.useState(1),[h,A]=l.useState(1),T=10,N=pe(P,500),[K,L]=l.useState(null),[Q,x]=l.useState(!1),[q,B]=l.useState(!1),[_,W]=l.useState(!1),[D,o]=l.useState(""),[F,p]=l.useState(""),[s,n]=l.useState({full_name:"",email:"",password:"",role:"student",subject:"",grade:"",language:"tj"}),[Y,g]=l.useState(!1),[c,ee]=l.useState(null),[I,k]=l.useState([]),[R,S]=l.useState(!1);l.useEffect(()=>{y(1)},[N]),l.useEffect(()=>{$()},[u,N]);const $=async()=>{U(!0);try{const{data:t,error:a}=await m.rpc("get_users_paginated",{page_number:u,items_per_page:T,search_query:N});if(a)throw a;if(t&&t.length>0){v(t);const r=t[0].total_count;A(Math.max(1,Math.ceil(r/T)))}else v([]),A(1)}catch(t){console.error("Ошибка загрузки пользователей:",t)}finally{U(!1)}},te=async(t,a)=>{if(!f&&(a==="admin"||a==="super_admin")){alert("У вас нет прав для назначения этой роли");return}L(t);try{const{error:r}=await m.rpc("update_user_role",{target_user_id:t,new_role:a});if(r)throw r;v(E.map(i=>i.id===t?{...i,role:a}:i))}catch(r){console.error("Ошибка обновления роли:",r),alert("Не удалось обновить роль")}finally{L(null)}},ae=async t=>{var a;if(t.preventDefault(),o(""),p(""),!s.email||!s.password){o("Email и пароль обязательны");return}if(s.password.length<6){o("Пароль должен быть не менее 6 символов");return}B(!0);try{const{data:r,error:i}=await he.auth.signUp({email:s.email,password:s.password,options:{data:{full_name:s.full_name}}});if(i)throw i;if(r.user){const{error:d}=await m.rpc("admin_upsert_profile",{target_id:r.user.id,target_full_name:s.full_name,target_role:s.role,target_subject:s.role==="teacher"?s.subject:null,target_grade:s.role==="student"&&parseInt(s.grade)||null,target_language:s.role==="student"?s.language:"tj"});d&&console.warn("Ошибка обновления профиля:",d)}p(`Пользователь ${s.email} успешно создан!`),n({full_name:"",email:"",password:"",role:"student",subject:"",grade:"",language:"tj"}),await $(),setTimeout(()=>{x(!1),p("")},1500)}catch(r){console.error("Ошибка создания пользователя:",r),(a=r.message)!=null&&a.includes("already registered")?o("Пользователь с таким email уже зарегистрирован"):o(r.message||"Ошибка при создании пользователя")}finally{B(!1)}},se=async t=>{ee(t),g(!0),S(!1);try{const{data:a}=await m.from("subject_permissions").select("*").eq("user_id",t.id),r=C.map(i=>{const d=a==null?void 0:a.find(ce=>ce.subject_id===i);return{subject_id:i,can_edit:(d==null?void 0:d.can_edit)||!1}});k(r)}catch(a){console.error("Ошибка загрузки прав:",a),k(C.map(r=>({subject_id:r,can_edit:!1})))}},re=t=>{k(a=>a.map(r=>r.subject_id===t?{...r,can_edit:!r.can_edit}:r))},le=async()=>{if(c){S(!0);try{await m.from("subject_permissions").delete().eq("user_id",c.id);const t=I.filter(a=>a.can_edit).map(a=>({user_id:c.id,subject_id:a.subject_id,can_edit:!0,granted_by:j==null?void 0:j.id}));if(t.length>0){const{error:a}=await m.from("subject_permissions").insert(t);if(a)throw a}g(!1)}catch(t){console.error("Ошибка сохранения прав:",t),alert("Не удалось сохранить права")}finally{S(!1)}}},ie=t=>{switch(t){case"super_admin":return e.jsx(ye,{className:"text-red-500",size:20});case"admin":return e.jsx(we,{className:"text-gaming-accent",size:20});case"teacher":return e.jsx(ve,{className:"text-gaming-primary",size:20});default:return e.jsx(ge,{className:"text-gray-400",size:20})}},ne=t=>{switch(t){case"super_admin":return"border-red-500/50 bg-red-500/10 text-red-400";case"admin":return"border-gaming-accent/50 bg-gaming-accent/10 text-gaming-accent";case"teacher":return"border-gaming-primary/50 bg-gaming-primary/10 text-gaming-primary";default:return"border-white/10 bg-white/5 text-gray-400"}},oe=()=>f?[{value:"student",label:"Ученик"},{value:"user",label:"Пользователь"},{value:"teacher",label:"Учитель"},{value:"admin",label:"Админ"},{value:"super_admin",label:"Супер Админ"}]:[{value:"student",label:"Ученик"},{value:"user",label:"Пользователь"},{value:"teacher",label:"Учитель"}],J=E;if(w)return e.jsx("div",{className:"min-h-screen pt-24 flex items-center justify-center",children:e.jsx(b,{className:"animate-spin text-gaming-primary",size:40})});const O=oe();return e.jsxs("div",{className:"min-h-screen pt-24 pb-12 px-4 container mx-auto max-w-7xl",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-heading font-bold text-white mb-2",children:"Управление пользователями"}),e.jsx("p",{className:"text-gaming-textMuted",children:f?"Полный доступ: управление ролями, правами и пользователями":"Управление учителями и учениками"})]}),e.jsxs("div",{className:"mb-6 flex gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400",size:20}),e.jsx("input",{type:"text",placeholder:"Поиск пользователей...",value:P,onChange:t=>H(t.target.value),className:"w-full bg-gaming-card border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white focus:outline-none focus:border-gaming-primary transition-colors"})]}),e.jsxs("button",{onClick:()=>{x(!0),o(""),p("")},className:"flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-gaming-primary to-gaming-purple text-white rounded-xl font-medium hover:scale-105 active:scale-95 transition-all shadow-lg shadow-gaming-primary/25 whitespace-nowrap",children:[e.jsx(M,{size:20}),"Добавить"]})]}),e.jsxs("div",{className:"bg-gaming-card border border-white/5 rounded-2xl overflow-hidden backdrop-blur-xl",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-white/5 bg-white/5",children:[e.jsx("th",{className:"p-4 text-gaming-textMuted font-medium",children:"Пользователь"}),e.jsx("th",{className:"p-4 text-gaming-textMuted font-medium",children:"Email"}),e.jsx("th",{className:"p-4 text-gaming-textMuted font-medium",children:"Роль"}),e.jsx("th",{className:"p-4 text-gaming-textMuted font-medium",children:"Действия"})]})}),e.jsx("tbody",{className:"divide-y divide-white/5",children:J.map(t=>e.jsxs("tr",{className:"hover:bg-white/5 transition-colors",children:[e.jsx("td",{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gaming-primary/20 flex items-center justify-center border border-gaming-primary/30",children:ie(t.role)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:t.full_name||"Без имени"}),e.jsxs("div",{className:"text-xs text-gaming-textMuted",children:["ID: ",t.id.slice(0,8),"..."]})]})]})}),e.jsx("td",{className:"p-4 text-gray-300",children:t.email||"Нет email"}),e.jsx("td",{className:"p-4",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs border ${ne(t.role)}`,children:t.role||"user"})}),e.jsx("td",{className:"p-4",children:e.jsx("div",{className:"flex items-center gap-2",children:K===t.id?e.jsx(b,{className:"animate-spin text-gaming-primary",size:20}):e.jsxs(e.Fragment,{children:[e.jsx("select",{value:t.role||"user",onChange:a=>te(t.id,a.target.value),className:"bg-black/40 border border-white/10 rounded-lg py-1.5 px-3 text-sm text-gray-300 focus:outline-none focus:border-gaming-primary cursor-pointer hover:bg-black/60 transition-colors",children:O.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}),t.role==="teacher"&&e.jsx("button",{onClick:()=>se(t),title:"Права на предметы",className:"p-2 rounded-lg bg-gaming-primary/10 border border-gaming-primary/30 text-gaming-primary hover:bg-gaming-primary/20 transition-all hover:scale-105 active:scale-95",children:e.jsx(_e,{size:16})})]})})})]},t.id))})]})}),J.length===0&&e.jsx("div",{className:"p-8 text-center text-gaming-textMuted",children:"Пользователи не найдены"})]}),h>1&&e.jsxs("div",{className:"flex justify-center items-center gap-4 mt-6",children:[e.jsx("button",{onClick:()=>y(t=>Math.max(1,t-1)),disabled:u===1||w,className:"p-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-white",children:e.jsx(be,{size:20})}),e.jsxs("span",{className:"text-gaming-textMuted",children:["Страница ",e.jsx("span",{className:"text-white font-bold",children:u})," из ",h]}),e.jsx("button",{onClick:()=>y(t=>Math.min(h,t+1)),disabled:u===h||w,className:"p-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-white",children:e.jsx(ue,{size:20})})]}),Q&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center px-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm",onClick:()=>x(!1)}),e.jsxs("div",{className:"relative bg-gaming-card border border-white/10 rounded-2xl p-6 w-full max-w-md shadow-2xl shadow-gaming-primary/10 animate-fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h2",{className:"text-xl font-heading font-bold text-white flex items-center gap-2",children:[e.jsx(M,{size:22,className:"text-gaming-primary"}),"Добавить пользователя"]}),e.jsx("button",{onClick:()=>x(!1),className:"text-gray-400 hover:text-white transition-colors p-1",children:e.jsx(V,{size:20})})]}),D&&e.jsx("div",{className:"mb-4 p-3 rounded-xl bg-red-500/10 border border-red-500/30 text-red-400 text-sm",children:D}),F&&e.jsx("div",{className:"mb-4 p-3 rounded-xl bg-green-500/10 border border-green-500/30 text-green-400 text-sm",children:F}),e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"ФИО"}),e.jsx("input",{type:"text",value:s.full_name,onChange:t=>n({...s,full_name:t.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 text-white placeholder-gray-500 focus:outline-none focus:border-gaming-primary transition-colors",placeholder:"Иванов Иван Иванович"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"Email *"}),e.jsx("input",{type:"email",required:!0,value:s.email,onChange:t=>n({...s,email:t.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 text-white placeholder-gray-500 focus:outline-none focus:border-gaming-primary transition-colors",placeholder:"user@example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"Пароль *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:_?"text":"password",required:!0,minLength:6,value:s.password,onChange:t=>n({...s,password:t.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 pr-12 text-white placeholder-gray-500 focus:outline-none focus:border-gaming-primary transition-colors",placeholder:"Минимум 6 символов"}),e.jsx("button",{type:"button",onClick:()=>W(!_),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors",children:_?e.jsx(fe,{size:18}):e.jsx(je,{size:18})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"Роль"}),e.jsx("select",{value:s.role,onChange:t=>n({...s,role:t.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 text-white focus:outline-none focus:border-gaming-primary transition-colors cursor-pointer",children:O.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),s.role==="teacher"&&e.jsxs("div",{className:"animate-fade-in-up",children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"Предмет"}),e.jsxs("select",{value:s.subject,onChange:t=>n({...s,subject:t.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 text-white focus:outline-none focus:border-gaming-primary transition-colors cursor-pointer",children:[e.jsx("option",{value:"",children:"Выберите предмет"}),C.map(t=>{var a;return e.jsx("option",{value:t,children:((a=G[t])==null?void 0:a[z])||t},t)})]})]}),s.role==="student"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 animate-fade-in-up",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"Класс"}),e.jsxs("select",{value:s.grade,onChange:t=>n({...s,grade:t.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 text-white focus:outline-none focus:border-gaming-primary transition-colors cursor-pointer",children:[e.jsx("option",{value:"",children:"Выберите..."}),[11,10,9,8,7,6,5].map(t=>e.jsxs("option",{value:t,children:[t," класс"]},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"Язык"}),e.jsxs("select",{value:s.language,onChange:t=>n({...s,language:t.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 text-white focus:outline-none focus:border-gaming-primary transition-colors cursor-pointer",children:[e.jsx("option",{value:"tj",children:"Тоҷикӣ"}),e.jsx("option",{value:"ru",children:"Русский"})]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:()=>x(!1),className:"flex-1 py-2.5 px-4 rounded-xl border border-white/10 text-gray-400 hover:bg-white/5 hover:text-white transition-all",children:"Отмена"}),e.jsx("button",{type:"submit",disabled:q,className:"flex-1 py-2.5 px-4 rounded-xl bg-gradient-to-r from-gaming-primary to-gaming-purple text-white font-medium hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 flex items-center justify-center gap-2",children:q?e.jsxs(e.Fragment,{children:[e.jsx(b,{size:18,className:"animate-spin"}),"Создание..."]}):e.jsxs(e.Fragment,{children:[e.jsx(M,{size:18}),"Создать"]})})]})]})]})]}),Y&&c&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center px-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm",onClick:()=>g(!1)}),e.jsxs("div",{className:"relative bg-gaming-card border border-white/10 rounded-2xl p-6 w-full max-w-lg shadow-2xl shadow-gaming-primary/10 animate-fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-heading font-bold text-white flex items-center gap-2",children:[e.jsx(xe,{size:22,className:"text-gaming-primary"}),"Права на предметы"]}),e.jsx("p",{className:"text-sm text-gaming-textMuted mt-1",children:c.full_name||c.email})]}),e.jsx("button",{onClick:()=>g(!1),className:"text-gray-400 hover:text-white transition-colors p-1",children:e.jsx(V,{size:20})})]}),e.jsx("div",{className:"space-y-2 max-h-[400px] overflow-y-auto pr-1",children:I.map(t=>{var a;return e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition-all ${t.can_edit?"border-gaming-primary/50 bg-gaming-primary/10":"border-white/5 bg-white/5 hover:bg-white/10"}`,children:[e.jsx("input",{type:"checkbox",checked:t.can_edit,onChange:()=>re(t.subject_id),className:"w-5 h-5 rounded border-white/20 bg-black/30 text-gaming-primary focus:ring-gaming-primary focus:ring-offset-0 cursor-pointer"}),e.jsx("span",{className:`font-medium ${t.can_edit?"text-white":"text-gray-400"}`,children:((a=G[t.subject_id])==null?void 0:a[z])||t.subject_id}),t.can_edit&&e.jsx("span",{className:"ml-auto text-xs text-gaming-primary bg-gaming-primary/10 px-2 py-0.5 rounded-full",children:"Редактирование"})]},t.subject_id)})}),e.jsxs("div",{className:"flex gap-3 pt-4 mt-4 border-t border-white/5",children:[e.jsx("button",{type:"button",onClick:()=>g(!1),className:"flex-1 py-2.5 px-4 rounded-xl border border-white/10 text-gray-400 hover:bg-white/5 hover:text-white transition-all",children:"Отмена"}),e.jsx("button",{onClick:le,disabled:R,className:"flex-1 py-2.5 px-4 rounded-xl bg-gradient-to-r from-gaming-primary to-gaming-purple text-white font-medium hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 flex items-center justify-center gap-2",children:R?e.jsxs(e.Fragment,{children:[e.jsx(b,{size:18,className:"animate-spin"}),"Сохранение..."]}):"Сохранить"})]})]})]})]})};export{Ae as default};
