import{e as B,u as se,c as re,r as l,k as d,j as e,L as h,X as T,B as le,S as ie,U as ne,m as q,n as oe}from"./index-CrMD2eKm.js";import{U as v}from"./user-plus-B2p8yFTY.js";import{E as ce,a as de}from"./eye-BWEePMy6.js";import{S as me,a as xe,b as ue}from"./shield-ByFL8waJ.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=B("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=B("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),we=()=>{const{t:pe,i18n:F}=se(),$=F.resolvedLanguage||"ru",{isSuperAdmin:p,profile:b}=re(),[N,_]=l.useState([]),[D,R]=l.useState(!0),[f,I]=l.useState(""),[J,S]=l.useState(null),[O,m]=l.useState(!1),[k,C]=l.useState(!1),[j,V]=l.useState(!1),[z,n]=l.useState(""),[M,g]=l.useState(""),[r,x]=l.useState({full_name:"",email:"",password:"",role:"student"}),[X,u]=l.useState(!1),[o,G]=l.useState(null),[U,y]=l.useState([]),[E,w]=l.useState(!1);l.useEffect(()=>{A()},[]);const A=async()=>{try{const{data:a,error:t}=await d.rpc("get_all_profiles");if(t)throw t;_(a||[])}catch(a){console.error("Ошибка загрузки пользователей:",a)}finally{R(!1)}},H=async(a,t)=>{if(!p&&(t==="admin"||t==="super_admin")){alert("У вас нет прав для назначения этой роли");return}S(a);try{const{error:s}=await d.rpc("update_user_role",{target_user_id:a,new_role:t});if(s)throw s;_(N.map(i=>i.id===a?{...i,role:t}:i))}catch(s){console.error("Ошибка обновления роли:",s),alert("Не удалось обновить роль")}finally{S(null)}},K=async a=>{var t;if(a.preventDefault(),n(""),g(""),!r.email||!r.password){n("Email и пароль обязательны");return}if(r.password.length<6){n("Пароль должен быть не менее 6 символов");return}C(!0);try{const{data:s,error:i}=await oe.auth.signUp({email:r.email,password:r.password,options:{data:{full_name:r.full_name}}});if(i)throw i;if(s.user){const{error:c}=await d.rpc("admin_upsert_profile",{target_id:s.user.id,target_full_name:r.full_name,target_role:r.role});c&&console.warn("Ошибка обновления профиля:",c)}g(`Пользователь ${r.email} успешно создан!`),x({full_name:"",email:"",password:"",role:"student"}),await A(),setTimeout(()=>{m(!1),g("")},1500)}catch(s){console.error("Ошибка создания пользователя:",s),(t=s.message)!=null&&t.includes("already registered")?n("Пользователь с таким email уже зарегистрирован"):n(s.message||"Ошибка при создании пользователя")}finally{C(!1)}},Q=async a=>{G(a),u(!0),w(!1);try{const{data:t}=await d.from("subject_permissions").select("*").eq("user_id",a.id),s=q.map(i=>{const c=t==null?void 0:t.find(te=>te.subject_id===i);return{subject_id:i,can_edit:(c==null?void 0:c.can_edit)||!1}});y(s)}catch(t){console.error("Ошибка загрузки прав:",t),y(q.map(s=>({subject_id:s,can_edit:!1})))}},W=a=>{y(t=>t.map(s=>s.subject_id===a?{...s,can_edit:!s.can_edit}:s))},Y=async()=>{if(o){w(!0);try{await d.from("subject_permissions").delete().eq("user_id",o.id);const a=U.filter(t=>t.can_edit).map(t=>({user_id:o.id,subject_id:t.subject_id,can_edit:!0,granted_by:b==null?void 0:b.id}));if(a.length>0){const{error:t}=await d.from("subject_permissions").insert(a);if(t)throw t}u(!1)}catch(a){console.error("Ошибка сохранения прав:",a),alert("Не удалось сохранить права")}finally{w(!1)}}},Z=a=>{switch(a){case"super_admin":return e.jsx(ue,{className:"text-red-500",size:20});case"admin":return e.jsx(xe,{className:"text-gaming-accent",size:20});case"teacher":return e.jsx(me,{className:"text-gaming-primary",size:20});default:return e.jsx(ne,{className:"text-gray-400",size:20})}},ee=a=>{switch(a){case"super_admin":return"border-red-500/50 bg-red-500/10 text-red-400";case"admin":return"border-gaming-accent/50 bg-gaming-accent/10 text-gaming-accent";case"teacher":return"border-gaming-primary/50 bg-gaming-primary/10 text-gaming-primary";default:return"border-white/10 bg-white/5 text-gray-400"}},ae=()=>p?[{value:"student",label:"Ученик"},{value:"user",label:"Пользователь"},{value:"teacher",label:"Учитель"},{value:"admin",label:"Админ"},{value:"super_admin",label:"Супер Админ"}]:[{value:"student",label:"Ученик"},{value:"user",label:"Пользователь"},{value:"teacher",label:"Учитель"}],L=N.filter(a=>{var t,s;return((t=a.email)==null?void 0:t.toLowerCase().includes(f.toLowerCase()))||((s=a.full_name)==null?void 0:s.toLowerCase().includes(f.toLowerCase()))});if(D)return e.jsx("div",{className:"min-h-screen pt-24 flex items-center justify-center",children:e.jsx(h,{className:"animate-spin text-gaming-primary",size:40})});const P=ae();return e.jsxs("div",{className:"min-h-screen pt-24 pb-12 px-4 container mx-auto max-w-7xl",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-heading font-bold text-white mb-2",children:"Управление пользователями"}),e.jsx("p",{className:"text-gaming-textMuted",children:p?"Полный доступ: управление ролями, правами и пользователями":"Управление учителями и учениками"})]}),e.jsxs("div",{className:"mb-6 flex gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ge,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400",size:20}),e.jsx("input",{type:"text",placeholder:"Поиск пользователей...",value:f,onChange:a=>I(a.target.value),className:"w-full bg-gaming-card border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white focus:outline-none focus:border-gaming-primary transition-colors"})]}),e.jsxs("button",{onClick:()=>{m(!0),n(""),g("")},className:"flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-gaming-primary to-gaming-purple text-white rounded-xl font-medium hover:scale-105 active:scale-95 transition-all shadow-lg shadow-gaming-primary/25 whitespace-nowrap",children:[e.jsx(v,{size:20}),"Добавить"]})]}),e.jsxs("div",{className:"bg-gaming-card border border-white/5 rounded-2xl overflow-hidden backdrop-blur-xl",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-white/5 bg-white/5",children:[e.jsx("th",{className:"p-4 text-gaming-textMuted font-medium",children:"Пользователь"}),e.jsx("th",{className:"p-4 text-gaming-textMuted font-medium",children:"Email"}),e.jsx("th",{className:"p-4 text-gaming-textMuted font-medium",children:"Роль"}),e.jsx("th",{className:"p-4 text-gaming-textMuted font-medium",children:"Действия"})]})}),e.jsx("tbody",{className:"divide-y divide-white/5",children:L.map(a=>e.jsxs("tr",{className:"hover:bg-white/5 transition-colors",children:[e.jsx("td",{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gaming-primary/20 flex items-center justify-center border border-gaming-primary/30",children:Z(a.role)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:a.full_name||"Без имени"}),e.jsxs("div",{className:"text-xs text-gaming-textMuted",children:["ID: ",a.id.slice(0,8),"..."]})]})]})}),e.jsx("td",{className:"p-4 text-gray-300",children:a.email||"Нет email"}),e.jsx("td",{className:"p-4",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs border ${ee(a.role)}`,children:a.role||"user"})}),e.jsx("td",{className:"p-4",children:e.jsx("div",{className:"flex items-center gap-2",children:J===a.id?e.jsx(h,{className:"animate-spin text-gaming-primary",size:20}):e.jsxs(e.Fragment,{children:[e.jsx("select",{value:a.role||"user",onChange:t=>H(a.id,t.target.value),className:"bg-black/40 border border-white/10 rounded-lg py-1.5 px-3 text-sm text-gray-300 focus:outline-none focus:border-gaming-primary cursor-pointer hover:bg-black/60 transition-colors",children:P.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),a.role==="teacher"&&e.jsx("button",{onClick:()=>Q(a),title:"Права на предметы",className:"p-2 rounded-lg bg-gaming-primary/10 border border-gaming-primary/30 text-gaming-primary hover:bg-gaming-primary/20 transition-all hover:scale-105 active:scale-95",children:e.jsx(he,{size:16})})]})})})]},a.id))})]})}),L.length===0&&e.jsx("div",{className:"p-8 text-center text-gaming-textMuted",children:"Пользователи не найдены"})]}),O&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center px-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm",onClick:()=>m(!1)}),e.jsxs("div",{className:"relative bg-gaming-card border border-white/10 rounded-2xl p-6 w-full max-w-md shadow-2xl shadow-gaming-primary/10 animate-fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h2",{className:"text-xl font-heading font-bold text-white flex items-center gap-2",children:[e.jsx(v,{size:22,className:"text-gaming-primary"}),"Добавить пользователя"]}),e.jsx("button",{onClick:()=>m(!1),className:"text-gray-400 hover:text-white transition-colors p-1",children:e.jsx(T,{size:20})})]}),z&&e.jsx("div",{className:"mb-4 p-3 rounded-xl bg-red-500/10 border border-red-500/30 text-red-400 text-sm",children:z}),M&&e.jsx("div",{className:"mb-4 p-3 rounded-xl bg-green-500/10 border border-green-500/30 text-green-400 text-sm",children:M}),e.jsxs("form",{onSubmit:K,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"ФИО"}),e.jsx("input",{type:"text",value:r.full_name,onChange:a=>x({...r,full_name:a.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 text-white placeholder-gray-500 focus:outline-none focus:border-gaming-primary transition-colors",placeholder:"Иванов Иван Иванович"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"Email *"}),e.jsx("input",{type:"email",required:!0,value:r.email,onChange:a=>x({...r,email:a.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 text-white placeholder-gray-500 focus:outline-none focus:border-gaming-primary transition-colors",placeholder:"user@example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"Пароль *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:j?"text":"password",required:!0,minLength:6,value:r.password,onChange:a=>x({...r,password:a.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 pr-12 text-white placeholder-gray-500 focus:outline-none focus:border-gaming-primary transition-colors",placeholder:"Минимум 6 символов"}),e.jsx("button",{type:"button",onClick:()=>V(!j),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors",children:j?e.jsx(ce,{size:18}):e.jsx(de,{size:18})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gaming-textMuted mb-1.5",children:"Роль"}),e.jsx("select",{value:r.role,onChange:a=>x({...r,role:a.target.value}),className:"w-full bg-black/30 border border-white/10 rounded-xl py-2.5 px-4 text-white focus:outline-none focus:border-gaming-primary transition-colors cursor-pointer",children:P.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:()=>m(!1),className:"flex-1 py-2.5 px-4 rounded-xl border border-white/10 text-gray-400 hover:bg-white/5 hover:text-white transition-all",children:"Отмена"}),e.jsx("button",{type:"submit",disabled:k,className:"flex-1 py-2.5 px-4 rounded-xl bg-gradient-to-r from-gaming-primary to-gaming-purple text-white font-medium hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 flex items-center justify-center gap-2",children:k?e.jsxs(e.Fragment,{children:[e.jsx(h,{size:18,className:"animate-spin"}),"Создание..."]}):e.jsxs(e.Fragment,{children:[e.jsx(v,{size:18}),"Создать"]})})]})]})]})]}),X&&o&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center px-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/70 backdrop-blur-sm",onClick:()=>u(!1)}),e.jsxs("div",{className:"relative bg-gaming-card border border-white/10 rounded-2xl p-6 w-full max-w-lg shadow-2xl shadow-gaming-primary/10 animate-fade-in-up",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-heading font-bold text-white flex items-center gap-2",children:[e.jsx(le,{size:22,className:"text-gaming-primary"}),"Права на предметы"]}),e.jsx("p",{className:"text-sm text-gaming-textMuted mt-1",children:o.full_name||o.email})]}),e.jsx("button",{onClick:()=>u(!1),className:"text-gray-400 hover:text-white transition-colors p-1",children:e.jsx(T,{size:20})})]}),e.jsx("div",{className:"space-y-2 max-h-[400px] overflow-y-auto pr-1",children:U.map(a=>{var t;return e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition-all ${a.can_edit?"border-gaming-primary/50 bg-gaming-primary/10":"border-white/5 bg-white/5 hover:bg-white/10"}`,children:[e.jsx("input",{type:"checkbox",checked:a.can_edit,onChange:()=>W(a.subject_id),className:"w-5 h-5 rounded border-white/20 bg-black/30 text-gaming-primary focus:ring-gaming-primary focus:ring-offset-0 cursor-pointer"}),e.jsx("span",{className:`font-medium ${a.can_edit?"text-white":"text-gray-400"}`,children:((t=ie[a.subject_id])==null?void 0:t[$])||a.subject_id}),a.can_edit&&e.jsx("span",{className:"ml-auto text-xs text-gaming-primary bg-gaming-primary/10 px-2 py-0.5 rounded-full",children:"Редактирование"})]},a.subject_id)})}),e.jsxs("div",{className:"flex gap-3 pt-4 mt-4 border-t border-white/5",children:[e.jsx("button",{type:"button",onClick:()=>u(!1),className:"flex-1 py-2.5 px-4 rounded-xl border border-white/10 text-gray-400 hover:bg-white/5 hover:text-white transition-all",children:"Отмена"}),e.jsx("button",{onClick:Y,disabled:E,className:"flex-1 py-2.5 px-4 rounded-xl bg-gradient-to-r from-gaming-primary to-gaming-purple text-white font-medium hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 flex items-center justify-center gap-2",children:E?e.jsxs(e.Fragment,{children:[e.jsx(h,{size:18,className:"animate-spin"}),"Сохранение..."]}):"Сохранить"})]})]})]})]})};export{we as default};
