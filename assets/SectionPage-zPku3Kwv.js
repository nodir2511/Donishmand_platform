import{j as t}from"./editor-y_DXvsmM.js";import{f as L,u as T,r as v,L as A}from"./vendor-DfgOC3sD.js";import{C as M}from"./CourseLayout-DfeFzTXm.js";import{u as k}from"./SyllabusContext-Co6vfvkw.js";import{u as E,s as b}from"./index-CZ7BpQlM.js";import{u as R,k as $,n as I,F as N,A as z}from"./ui-DqTeed5j.js";import"./supabase-CQnWzhEg.js";const w="donishmand_topic_stats",y=()=>{try{const e=localStorage.getItem(w);return e?JSON.parse(e):{}}catch{return{}}},F=e=>{try{const r=y();localStorage.setItem(w,JSON.stringify({...r,...e}))}catch{}},O=e=>{const r={};for(const n of e)r[n.lesson_id]||(r[n.lesson_id]=[]),r[n.lesson_id].push(n);const o={};for(const[n,c]of Object.entries(r)){const a=c.length,g=Math.max(...c.map(l=>l.score)),d=c.reduce((l,x)=>l+x.score,0)/a,i=Math.round(100-d);o[n]={totalAttempts:a,bestScore:g,avgErrorRate:i,avgScore:d}}return o},S=(e,r)=>{let o=0,n=0;for(const c of e){const a=r[c];a&&(o++,n+=a.avgScore)}return o===0?null:{completedLessons:o,totalLessons:e.length,avgErrorRate:Math.round(100-n/o)}},P=({subjectId:e,sectionId:r,isTeacher:o,navigate:n,lessonStats:c})=>{const{t:a,i18n:g}=R(),d=g.resolvedLanguage||"ru",{subjectData:i,loading:l}=k();if(l)return t.jsx("div",{className:"flex items-center justify-center min-h-[40vh]",children:t.jsx($,{size:40,className:"text-gaming-primary animate-spin"})});const x=i==null?void 0:i.sections.find(s=>s.id===r),m=(i==null?void 0:i.sections.findIndex(s=>s.id===r))??-1;if(!x)return t.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[40vh] text-white",children:[t.jsx("h2",{className:"text-2xl mb-4",children:a("sectionNotFound")}),t.jsx("button",{onClick:()=>n(`/subject/${e}`),className:"text-gaming-primary hover:underline",children:a("backToSubject")})]});const h=s=>d==="tj"&&s.titleTj?s.titleTj:s.title,f=x.topics.flatMap(s=>s.lessons.map(p=>p.id)),u=S(f,c);return t.jsxs("div",{className:"max-w-5xl",children:[t.jsxs("h1",{className:"text-3xl font-bold mb-2 text-gaming-primary",children:[m+1,". ",h(x)]}),t.jsxs("div",{className:"flex items-center gap-4 mb-8",children:[t.jsxs("button",{onClick:()=>n(`/subject/${e}`),className:"flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-gaming-textMuted hover:text-white transition-all group w-fit",children:[t.jsx(I,{size:18,className:"group-hover:-translate-x-1 transition-transform"}),t.jsx("span",{className:"text-sm font-medium",children:a("backToSubject")})]}),t.jsxs("p",{className:"text-gaming-textMuted",children:[x.topics.length," ",a("themesCount")]})]}),u&&!o&&t.jsxs("div",{className:"mb-8 p-6 bg-gradient-to-r from-gaming-accent/10 to-gaming-blue/10 rounded-2xl border border-white/5 flex items-center gap-6",children:[t.jsx("div",{className:"p-4 bg-gaming-accent/20 rounded-full text-gaming-accent",children:t.jsx(N,{size:32})}),t.jsxs("div",{children:[t.jsxs("div",{className:"text-3xl font-bold text-white mb-1",children:[u.avgErrorRate,"%"]}),t.jsx("div",{className:"text-gaming-textMuted text-sm",children:d==="ru"?"Средний % ошибок по разделу":"Миёна % хатогиҳо дар бахш"}),t.jsx("div",{className:"text-xs text-gaming-textMuted mt-1 opacity-70",children:d==="ru"?`На основе ${u.completedLessons} пройденных уроков`:`Дар асоси ${u.completedLessons} дарсҳои гузашта`})]})]}),t.jsx("div",{className:"space-y-4",children:x.topics.map((s,p)=>{const _=s.lessons.map(C=>C.id),j=S(_,c);return t.jsxs(A,{to:`/subject/${e}/section/${r}/topic/${s.id}`,className:"group flex items-center gap-4 bg-gaming-card/40 backdrop-blur-xl border border-white/5 p-5 rounded-2xl hover:border-gaming-accent/50 transition-all duration-300 hover:bg-gaming-card/60",children:[t.jsx("div",{className:"w-12 h-12 rounded-xl bg-gaming-accent/10 flex items-center justify-center text-gaming-accent group-hover:scale-110 transition-transform",children:t.jsx(N,{size:24})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("h3",{className:"text-lg font-bold group-hover:text-gaming-accent transition-colors truncate",children:[m+1,".",p+1,". ",h(s)]}),t.jsxs("p",{className:"text-sm text-gaming-textMuted",children:[s.lessons.length," ",a("lessonsCount")]})]}),j&&!o&&t.jsxs("div",{className:"mr-2 text-right",children:[t.jsxs("div",{className:"text-xl font-bold text-white leading-none",children:[j.avgErrorRate,"%"]}),t.jsx("div",{className:"text-[10px] text-gaming-textMuted uppercase tracking-wider opacity-70",children:d==="ru"?"ошибок":"хато"})]}),t.jsx(z,{className:"text-white/20 group-hover:text-gaming-accent transition-colors shrink-0"})]},s.id)})})]})},Q=()=>{const{subjectId:e,sectionId:r}=L(),o=T(),{isTeacher:n,isAdmin:c,profile:a}=E(),g=n||c,[d,i]=v.useState(()=>y());return v.useEffect(()=>{if(g||!a)return;let l=!1;return(async()=>{try{const{data:{user:m}}=await b.auth.getUser();if(!(m!=null&&m.id)||l)return;const{data:h,error:f}=await b.from("user_test_results").select("lesson_id, score, correct_count, total_questions, is_passed, created_at").eq("user_id",m.id);if(f||!h||l)return;const u=O(h);l||(i(u),F(u))}catch(m){console.error("Ошибка загрузки статистики раздела:",m)}})(),()=>{l=!0}},[a,g]),t.jsx(M,{subjectId:e,children:t.jsx(P,{subjectId:e,sectionId:r,isTeacher:g,navigate:o,lessonStats:d})})};export{Q as default};
