import{j as t}from"./editor-y_DXvsmM.js";import{f as C,u as T,r as b,L}from"./vendor-DfgOC3sD.js";import{u as M,S as A,s as v}from"./index-CZ7BpQlM.js";import{C as k}from"./CourseLayout-DfeFzTXm.js";import{u as E}from"./SyllabusContext-Co6vfvkw.js";import{u as S,k as R,n as I,o as N,A as z}from"./ui-DqTeed5j.js";import"./supabase-CQnWzhEg.js";const y="donishmand_topic_stats",w=()=>{try{const r=localStorage.getItem(y);return r?JSON.parse(r):{}}catch{return{}}},O=r=>{try{const a=w();localStorage.setItem(y,JSON.stringify({...a,...r}))}catch{}},J=r=>{const a={};for(const e of r)a[e.lesson_id]||(a[e.lesson_id]=[]),a[e.lesson_id].push(e);const o={};for(const[e,c]of Object.entries(a)){const s=c.length,g=Math.max(...c.map(d=>d.score)),m=c.reduce((d,h)=>d+h.score,0)/s,l=Math.round(100-m);o[e]={totalAttempts:s,bestScore:g,avgErrorRate:l,avgScore:m}}return o},P=(r,a)=>{let o=0,e=0;for(const c of r){const s=a[c];s&&(o++,e+=s.avgScore)}return o===0?null:{completedLessons:o,totalLessons:r.length,avgErrorRate:Math.round(100-e/o)}},q=({subjectId:r,subjectName:a,isTeacher:o,navigate:e,lessonStats:c})=>{const{t:s,i18n:g}=S(),m=g.resolvedLanguage||"ru",{subjectData:l,loading:d}=E();if(d)return t.jsx("div",{className:"flex items-center justify-center min-h-[40vh]",children:t.jsx(R,{size:40,className:"text-gaming-primary animate-spin"})});if(!l)return t.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[40vh] text-white",children:[t.jsx("h2",{className:"text-2xl mb-4",children:s("subjectNotFound")}),t.jsx("button",{onClick:()=>e("/"),className:"text-gaming-primary hover:underline",children:s("backToMain")})]});const h=n=>m==="tj"&&n.titleTj?n.titleTj:n.title;return t.jsxs("div",{className:"max-w-5xl",children:[t.jsx("h1",{className:"text-4xl font-bold mb-2 text-white",children:a}),t.jsxs("div",{className:"flex items-center gap-4 mb-8",children:[t.jsxs("button",{onClick:()=>e("/"),className:"flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-gaming-textMuted hover:text-white transition-all group w-fit",children:[t.jsx(I,{size:18,className:"group-hover:-translate-x-1 transition-transform"}),t.jsx("span",{className:"text-sm font-medium",children:s("backToMain")})]}),t.jsx("p",{className:"text-gaming-textMuted text-lg",children:s("selectSection")})]}),t.jsx("div",{className:"space-y-4",children:l.sections.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[30vh] text-center",children:[t.jsx("div",{className:"w-20 h-20 rounded-2xl bg-gaming-primary/10 flex items-center justify-center mb-4",children:t.jsx(N,{size:36,className:"text-gaming-primary"})}),t.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:s("contentDeveloping")}),t.jsx("p",{className:"text-gaming-textMuted max-w-md",children:s("contentComingSoon")})]}):l.sections.map((n,p)=>{const u=n.topics.flatMap(i=>i.lessons.map(x=>x.id)),f=P(u,c);return t.jsxs(L,{to:`/subject/${r}/section/${n.id}`,className:"group flex items-center gap-4 bg-gaming-card/40 backdrop-blur-xl border border-white/5 p-5 rounded-2xl hover:border-gaming-primary/50 transition-all duration-300 hover:bg-gaming-card/60",children:[t.jsx("div",{className:"w-12 h-12 rounded-xl bg-gaming-primary/10 flex items-center justify-center text-gaming-primary group-hover:scale-110 transition-transform",children:t.jsx(N,{size:24})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("h3",{className:"text-lg font-bold group-hover:text-gaming-primary transition-colors truncate",children:[p+1,". ",h(n)]}),t.jsxs("p",{className:"text-sm text-gaming-textMuted",children:[n.topics.length," ",s("themesCount")," • ",n.topics.reduce((i,x)=>i+x.lessons.length,0)," ",s("lessonsCount")]})]}),f&&!o&&t.jsxs("div",{className:"mr-2 text-right",children:[t.jsxs("div",{className:"text-xl font-bold text-white leading-none",children:[f.avgErrorRate,"%"]}),t.jsx("div",{className:"text-[10px] text-gaming-textMuted uppercase tracking-wider opacity-70",children:m==="ru"?"ошибок":"хато"})]}),t.jsx(z,{className:"text-white/20 group-hover:text-gaming-primary transition-colors shrink-0"})]},n.id)})})]})},Y=()=>{var p;const{t:r,i18n:a}=S(),o=a.resolvedLanguage||"ru",{subjectId:e}=C(),c=T(),{isTeacher:s,isAdmin:g,profile:m}=M(),l=s||g,d=((p=A[e])==null?void 0:p[o])||e,[h,n]=b.useState(()=>w());return b.useEffect(()=>{if(l||!m)return;let u=!1;return(async()=>{try{const{data:{user:i}}=await v.auth.getUser();if(!(i!=null&&i.id)||u)return;const{data:x,error:_}=await v.from("user_test_results").select("lesson_id, score, correct_count, total_questions, is_passed, created_at").eq("user_id",i.id);if(_||!x||u)return;const j=J(x);u||(n(j),O(j))}catch(i){console.error("Ошибка загрузки статистики предмета:",i)}})(),()=>{u=!0}},[m,l]),t.jsx(k,{subjectId:e,children:t.jsx(q,{subjectId:e,subjectName:d,isTeacher:l,navigate:c,lessonStats:h})})};export{Y as default};
