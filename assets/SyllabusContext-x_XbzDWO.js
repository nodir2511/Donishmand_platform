import{e as P,s as L,r as A,j as F}from"./index-DRfO7QNx.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=P("Book",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20",key:"t4utmx"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=P("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]),N=t=>{var a,m,c,x,j,v,I;if(!t)return{contentRu:null,contentTj:null};const g=R=>{if(!R||!Array.isArray(R))return{ru:[],tj:[]};const M=R.map(r=>{const e={id:r.id,type:r.type,image:r.imageRu||r.image};return e.text=r.textRu||"",r.type==="multiple_choice"?(e.options=(r.options||[]).map(i=>({id:i.id,text:i.textRu||"",image:i.imageRu||i.image})),e.correctId=r.correctId):r.type==="matching"?(e.leftItems=(r.leftItems||[]).map(i=>({id:i.id,text:i.textRu||"",image:i.imageRu||i.image})),e.rightItems=(r.rightItems||[]).map(i=>({id:i.id,text:i.textRu||"",image:i.imageRu||i.image})),e.correctMatches=r.correctMatches):r.type==="numeric"&&(e.digits=r.digits,e.unit=r.unit),e}),k=R.map(r=>{const e={id:r.id,type:r.type,image:r.imageTj||r.imageRu||r.image};return e.text=r.textTj||"",r.type==="multiple_choice"?(e.options=(r.options||[]).map(i=>({id:i.id,text:i.textTj||"",image:i.imageTj||i.imageRu||i.image})),e.correctId=r.correctId):r.type==="matching"?(e.leftItems=(r.leftItems||[]).map(i=>({id:i.id,text:i.textTj||"",image:i.imageTj||i.imageRu||i.image})),e.rightItems=(r.rightItems||[]).map(i=>({id:i.id,text:i.textTj||"",image:i.imageTj||i.imageRu||i.image})),e.correctMatches=r.correctMatches):r.type==="numeric"&&(e.digits=r.digits,e.unit=r.unit),e});return{ru:M,tj:k}},{ru:s,tj:u}=g((a=t.test)==null?void 0:a.questions);return{contentRu:{video:{url:((m=t.video)==null?void 0:m.url)||"",description:((c=t.video)==null?void 0:c.descriptionRu)||""},text:{body:((x=t.text)==null?void 0:x.bodyRu)||""},test:{questions:s},slides:t.slidesRu||[]},contentTj:{video:{url:((j=t.video)==null?void 0:j.urlTj)||"",description:((v=t.video)==null?void 0:v.descriptionTj)||""},text:{body:((I=t.text)==null?void 0:I.bodyTj)||""},test:{questions:u},slides:t.slidesTj||[]}}},z=(t,g)=>{var v,I,R,M,k,r,e,i,f,p;const s=n=>n?n.toString().replace(/<[^>]*>?/gm,"").replace(/&nbsp;/g," ").trim():"",u=n=>{const T=s(n);return T!==""&&/^\d+$/.test(T)},a=n=>{if(!n)return"";const T=[n.textRu,n.textTj,n.question,n.text,n.title];for(const d of T)if(d&&!u(d))return d;return""},m=n=>!n||!Array.isArray(n)?n:n.map(T=>{const d={...T};if((!d.textRu||u(d.textRu))&&(d.textRu=a(T)),!d.textTj||u(d.textTj)){const l=[T.textTj,T.question,T.text,T.title];for(const C of l)if(C&&!u(C)&&C!==d.textRu){d.textTj=C;break}}return d.options&&(d.options=d.options.map(l=>({...l,textRu:!l.textRu||u(l.textRu)?a(l):l.textRu,textTj:l.textTj||""}))),d.leftItems&&(d.leftItems=d.leftItems.map(l=>({...l,textRu:!l.textRu||u(l.textRu)?a(l):l.textRu,textTj:l.textTj||""}))),d.rightItems&&(d.rightItems=d.rightItems.map(l=>({...l,textRu:!l.textRu||u(l.textRu)?a(l):l.textRu,textTj:l.textTj||""}))),d});if(t&&(t.slidesRu||(v=t.text)!=null&&v.bodyRu))return(I=t.test)!=null&&I.questions?{...t,test:{...t.test,questions:m(t.test.questions)}}:t;const c=t||{},x=g||{},j=(n,T)=>{const d=n||[],l=T||[],C=o=>o?o.toString().replace(/<[^>]*>?/gm,"").replace(/&nbsp;/g," ").trim():"",$=o=>{const H=C(o);return H!==""&&/^\d+$/.test(H)},b=o=>{if(!o)return"";const H=[o.textRu,o.textTj,o.question,o.text,o.title];for(const h of H)if(h&&!$(h))return h;return""};return d.map((o,H)=>{const h=l[H]||{},_={id:o.id,type:o.type,imageRu:o.image,imageTj:h.image,textRu:b(o),textTj:b(h)};return o.type==="multiple_choice"?(_.options=(o.options||[]).map((y,Q)=>{var w;const S=((w=h.options)==null?void 0:w[Q])||{};return{id:y.id,imageRu:y.image,imageTj:S.image,textRu:b(y),textTj:b(S)}}),_.correctId=o.correctId):o.type==="matching"?(_.leftItems=(o.leftItems||[]).map((y,Q)=>{var w;const S=((w=h.leftItems)==null?void 0:w[Q])||{};return{id:y.id,imageRu:y.image,imageTj:S.image,textRu:b(y),textTj:b(S)}}),_.rightItems=(o.rightItems||[]).map((y,Q)=>{var w;const S=((w=h.rightItems)==null?void 0:w[Q])||{};return{id:y.id,imageRu:y.image,imageTj:S.image,textRu:b(y),textTj:b(S)}}),_.correctMatches=o.correctMatches):o.type==="numeric"&&(_.digits=o.digits,_.unit=o.unit),_})};return{video:{url:((R=c.video)==null?void 0:R.url)||"",urlTj:((M=x.video)==null?void 0:M.url)||"",descriptionRu:((k=c.video)==null?void 0:k.description)||"",descriptionTj:((r=x.video)==null?void 0:r.description)||""},text:{bodyRu:((e=c.text)==null?void 0:e.body)||"",bodyTj:((i=x.text)==null?void 0:i.body)||""},test:{questions:j((f=c.test)==null?void 0:f.questions,(p=x.test)==null?void 0:p.questions)},slidesRu:c.slides||[],slidesTj:x.slides||[]}},B={structures:{},lessons:{}},D={invalidateCache(t){t?delete B.structures[t]:(B.structures={},B.lessons={})},async saveStructure(t,g){const s=g.sections.map(a=>({id:a.id,title:a.title,titleTj:a.titleTj,topics:a.topics.map(m=>({id:m.id,title:m.title,titleTj:m.titleTj,lessons:m.lessons.map(c=>({id:c.id,title:c.title,titleTj:c.titleTj,type:c.type}))}))})),{error:u}=await L.from("subject_syllabus").upsert({subject:t,data:{sections:s},updated_at:new Date},{onConflict:"subject"});if(u)throw console.error("Ошибка сохранения структуры:",u),u;return!0},async getStructure(t){if(B.structures[t])return B.structures[t];const{data:g,error:s}=await L.from("subject_syllabus").select("data").eq("subject",t).single();if(s){if(s.code==="PGRST116")return null;throw s}return B.structures[t]=g.data,g.data},async saveLesson(t,g){const{contentRu:s,contentTj:u}=N(t.content),{error:a}=await L.from("lessons").upsert({id:t.id,title_ru:t.title,title_tj:t.titleTj,subject:g,content_ru:s,content_tj:u,is_published:!0,updated_at:new Date},{onConflict:"id"});if(a)throw a;return!0},async getLesson(t,g=null){var c;const s=g==="ru"?"id, title_ru, title_tj, subject, content_ru":g==="tj"?"id, title_ru, title_tj, subject, content_tj":"*",{data:u,error:a}=await L.from("lessons").select(s).eq("id",t).single();if(a){if(a.code==="PGRST116")return null;throw a}let m;if(g){const x=g==="ru"?u.content_ru:u.content_tj;x&&(x.slidesRu||(c=x.text)!=null&&c.bodyRu)?m=x:m=G(x,g)}else m=z(u.content_ru,u.content_tj);return{id:u.id,title:u.title_ru,titleTj:u.title_tj,content:m,subject:u.subject}}},G=(t,g)=>{var a,m,c,x,j,v,I;if(!t)return{video:{url:"",urlTj:"",descriptionRu:"",descriptionTj:""},text:{bodyRu:"",bodyTj:""},test:{questions:[]},slidesRu:[],slidesTj:[]};const s=g==="ru",u=R=>{const M=e=>e?e.toString().replace(/<[^>]*>?/gm,"").replace(/&nbsp;/g," ").trim():"",k=e=>{const i=M(e);return i!==""&&/^\d+$/.test(i)},r=e=>{if(!e)return"";const i=[e.textRu,e.textTj,e.question,e.text,e.title];for(const f of i)if(f&&!k(f))return f;return""};return(R||[]).map(e=>{const i=r(e),f={id:e.id,type:e.type,imageRu:s&&e.image||null,imageTj:s?null:e.image||null,textRu:s?i:"",textTj:s?"":i};return e.type==="multiple_choice"?(f.options=(e.options||[]).map(p=>{const n=r(p);return{id:p.id,imageRu:s&&p.image||null,imageTj:s?null:p.image||null,textRu:s?n:"",textTj:s?"":n}}),f.correctId=e.correctId):e.type==="matching"?(f.leftItems=(e.leftItems||[]).map(p=>{const n=r(p);return{id:p.id,imageRu:s&&p.image||null,imageTj:s?null:p.image||null,textRu:s?n:"",textTj:s?"":n}}),f.rightItems=(e.rightItems||[]).map(p=>{const n=r(p);return{id:p.id,imageRu:s&&p.image||null,imageTj:s?null:p.image||null,textRu:s?n:"",textTj:s?"":n}}),f.correctMatches=e.correctMatches):e.type==="numeric"&&(f.digits=e.digits,f.unit=e.unit),f})};return{video:{url:s&&((a=t.video)==null?void 0:a.url)||"",urlTj:s?"":((m=t.video)==null?void 0:m.url)||"",descriptionRu:s&&((c=t.video)==null?void 0:c.description)||"",descriptionTj:s?"":((x=t.video)==null?void 0:x.description)||""},text:{bodyRu:s&&((j=t.text)==null?void 0:j.body)||"",bodyTj:s?"":((v=t.text)==null?void 0:v.body)||""},test:{questions:u((I=t.test)==null?void 0:I.questions)},slidesRu:s?t.slides||[]:[],slidesTj:s?[]:t.slides||[]}},E=A.createContext(null),K=t=>{D.invalidateCache(t)},U=({subjectId:t,children:g})=>{const[s,u]=A.useState(null),[a,m]=A.useState(!0);return A.useEffect(()=>{let c=!0;return t?(async()=>{m(!0);try{const j=await D.getStructure(t);c&&u(j||{sections:[]})}catch(j){console.error(`Ошибка загрузки структуры предмета "${t}":`,j),c&&u({sections:[]})}finally{c&&m(!1)}})():m(!1),()=>{c=!1}},[t]),F.jsx(E.Provider,{value:{subjectData:s,loading:a,subjectId:t},children:g})},W=()=>{const t=A.useContext(E);if(t===null)throw new Error("useSyllabus должен использоваться внутри SyllabusProvider");return t};export{Z as B,J as F,U as S,K as i,D as s,W as u};
