import{j as e}from"./editor-y_DXvsmM.js";import{r as m,R as ce}from"./vendor-DfgOC3sD.js";import{r as Y}from"./LessonPage-CYrrL5SL.js";import{u as oe,s as H}from"./index-BX-jT5UU.js";import{al as z,r as F,R as de,X as me,a4 as P,q as xe,ao as ue,g as he}from"./ui-DqTeed5j.js";import"./CourseLayout-Buqr-hqM.js";import"./SyllabusContext-BwXa2ym8.js";import"./katex-G9EdgA5J.js";import"./supabase-CQnWzhEg.js";const v=b=>{const u=[...b];for(let i=u.length-1;i>0;i--){const S=Math.floor(Math.random()*(i+1));[u[i],u[S]]=[u[S],u[i]]}return u},D=80,Se=({questions:b,lessonId:u,lang:i,onClose:S,onComplete:V})=>{const[g,k]=m.useState(0),[x,T]=m.useState({}),[$,J]=m.useState(!1),[U,Z]=m.useState(0),[_,L]=m.useState(!1),[W,R]=m.useState(""),[E,O]=m.useState(new Set),{isTeacher:q,isAdmin:ee}=oe(),te=q||ee,[K,se]=m.useState(!0);ce.useEffect(()=>{const t=()=>{const a=document.hasFocus()&&!document.hidden;se(a)};window.addEventListener("focus",t),window.addEventListener("blur",t),document.addEventListener("visibilitychange",t);const s=setInterval(t,300);return()=>{window.removeEventListener("focus",t),window.removeEventListener("blur",t),document.removeEventListener("visibilitychange",t),clearInterval(s)}},[]);const N=`test_progress_v2_${u}`,p=m.useMemo(()=>{if(!b)return[];const t=localStorage.getItem(N);if(t&&U===0)try{const r=JSON.parse(t);if(!(r.questions&&r.questions.every(o=>o.textRu&&o.textRu.trim().length>0||o.textTj&&o.textTj.trim().length>0)))console.warn("Кэш теста содержит пустые вопросы. Очистка..."),localStorage.removeItem(N);else if(r.questions&&r.answers&&r.locked){T(r.answers),O(new Set(r.locked)),k(r.currentIndex||0);const o=new Set(r.locked),w=r.questions.filter(n=>o.has(n.id)),A=new Set(w.map(n=>n.id)),c=v(b.filter(n=>!A.has(n.id))),h=Math.min(10,b.length)-w.length,f=c.slice(0,Math.max(0,h)).map(n=>n.type==="multiple_choice"?{...n,options:v(n.options)}:n.type==="matching"?{...n,leftItems:v(n.leftItems),rightItems:v(n.rightItems)}:n);return[...w,...f]}}catch(r){console.warn("Ошибка восстановления прогресса теста:",r),localStorage.removeItem(N)}return v(b).slice(0,10).map(r=>r.type==="multiple_choice"?{...r,options:v(r.options)}:r.type==="matching"?{...r,leftItems:v(r.leftItems),rightItems:v(r.rightItems)}:r)},[b,U,N]),l=p[g],y=p.length;m.useEffect(()=>{if(p.length>0&&!$){const t={questions:p,answers:x,locked:[...E],currentIndex:g};localStorage.setItem(N,JSON.stringify(t))}},[x,E,g,p,$]);const C=t=>E.has(t),X=()=>{const t=p[g];if(!t)return;const s=x[t.id];s!=null&&s!==""&&O(a=>new Set([...a,t.id]))},Q=(t,s)=>{C(t)||T(a=>({...a,[t]:s}))},re=()=>{g<y-1&&(X(),k(t=>t+1))},ie=()=>{g>0&&k(t=>t-1)},[j,B]=m.useState(null),I=m.useMemo(()=>p.filter(t=>{const s=x[t.id];return s==null||s===""?!0:t.type==="matching"&&typeof s=="object"?Object.keys(s).length<t.leftItems.length:!1}).length,[x,p]);m.useEffect(()=>{if(_){const t=setTimeout(()=>{L(!1),R("")},3e3);return()=>clearTimeout(t)}},[_]);const ne=()=>{if(X(),I>0){L(!0);const c=i==="ru"?`Вы не ответили на ${I} ${I===1?"вопрос":I<5?"вопроса":"вопросов"}!`:`Шумо ба ${I} савол ҷавоб надодаед!`;R(c);return}let t=0;const s=p.map(c=>{const h=x[c.id];let f=!1;if(c.type==="multiple_choice")f=h===c.correctId;else if(c.type==="matching")f=Object.entries(c.correctMatches).every(([n,le])=>(h==null?void 0:h[n])===le);else if(c.type==="numeric"){const n=c.digits.join("");f=h===n}return f&&t++,{question:c,userAnswer:h,isCorrect:f}}),a=Math.round(t/y*100),r=a>=D,d=`test_history_${u}`,o=JSON.parse(localStorage.getItem(d)||"[]"),w={score:a,correct:t,total:y,timestamp:Date.now(),passed:r},A=[...o,w];if(localStorage.setItem(d,JSON.stringify(A)),localStorage.setItem(`test_result_${u}`,JSON.stringify(w)),te||H.auth.getUser().then(({data:c})=>{var h;if((h=c==null?void 0:c.user)!=null&&h.id){const f=c.user.id;H.from("user_test_results").insert({user_id:f,lesson_id:u,score:a,correct_count:t,total_questions:y,is_passed:r,answers_detail:s.map(n=>({question_id:n.question.id,question_text:(n.question.textRu||"").slice(0,150),is_correct:n.isCorrect,type:n.question.type}))}).then(({error:n})=>{n&&console.error("Ошибка сохранения результата теста:",n)}),r&&H.from("coin_transactions").insert({user_id:f,amount:1}).then(({error:n})=>{n&&console.error("Ошибка начисления монеты:",n)})}}),r){const c=parseInt(localStorage.getItem("user_coins")||"0");localStorage.setItem("user_coins",(c+1).toString())}B({correct:t,total:y,score:a,isPassed:r,details:s}),J(!0),localStorage.removeItem(N)},ae=()=>{localStorage.removeItem(N),k(0),T({}),L(!1),R(""),O(new Set),B(null),J(!1),Z(t=>t+1)},G=t=>{const s=i==="tj"&&t.textTj||t.textRu;return Y(s||"")},M=t=>{const s=i==="tj"&&t.textTj||t.textRu;return Y(s||"")};return!b||b.length===0?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-gaming-card/95 rounded-2xl p-8 text-center max-w-md",children:[e.jsx(z,{size:48,className:"mx-auto mb-4 text-red-400"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:i==="ru"?"Нет вопросов":"Саволе нест"}),e.jsx("p",{className:"text-gaming-textMuted mb-4",children:i==="ru"?"Тест пока не содержит вопросов":"Тест ҳанӯз савол надорад"}),e.jsx("button",{onClick:S,className:"px-6 py-2 bg-gaming-primary text-white rounded-xl",children:i==="ru"?"Закрыть":"Пӯшидан"})]})}):$&&j?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 overflow-y-auto",children:e.jsxs("div",{className:"w-full max-w-2xl bg-gaming-card/95 rounded-3xl border border-white/10 my-8",children:[e.jsxs("div",{className:"p-6 border-b border-white/10 text-center relative overflow-hidden",children:[j.isPassed?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 bg-green-500/10"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{className:"w-24 h-24 mx-auto mb-4 bg-yellow-400 rounded-full flex items-center justify-center shadow-[0_0_30px_rgba(250,204,21,0.6)] animate-bounce",children:e.jsx("div",{className:"w-20 h-20 border-4 border-yellow-600 rounded-full flex items-center justify-center bg-yellow-300",children:e.jsx("span",{className:"text-4xl font-bold text-yellow-700",children:"$"})})}),e.jsx("h2",{className:"text-3xl font-bold mb-2 text-green-400",children:i==="ru"?"Тест сдан!":"Тест супорида шуд!"}),e.jsx("p",{className:"text-green-300/80 mb-2",children:i==="ru"?"+1 монета в копилку":"+1 танга ба хазина"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 bg-red-500/10"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx(z,{size:64,className:"mx-auto mb-4 text-red-500"}),e.jsx("h2",{className:"text-3xl font-bold mb-2 text-red-400",children:i==="ru"?"Тест не сдан":"Тест супорида нашуд"}),e.jsx("p",{className:"text-red-300/80 mb-2",children:i==="ru"?`Нужно набрать минимум ${D}%`:`Бояд ҳадди аққал ${D}% гиред`})]})]}),e.jsxs("div",{className:`text-5xl font-bold mb-2 relative z-10 ${j.isPassed?"text-green-400":"text-red-400"}`,children:[j.score,"%"]}),e.jsxs("p",{className:"text-gaming-textMuted relative z-10",children:[j.correct," / ",j.total," ",i==="ru"?"правильных ответов":"ҷавоби дуруст"]})]}),e.jsx("div",{className:"p-6 max-h-[50vh] overflow-y-auto space-y-4",children:j.details.map((t,s)=>e.jsx("div",{className:`p-4 rounded-xl border ${t.isCorrect?"bg-green-500/10 border-green-500/30":"bg-red-500/10 border-red-500/30"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[t.isCorrect?e.jsx(F,{className:"text-green-400 mt-1",size:20}):e.jsx(z,{className:"text-red-400 mt-1",size:20}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium mb-1 flex gap-1",children:[e.jsxs("span",{children:[s+1,"."]}),e.jsx("div",{dangerouslySetInnerHTML:{__html:G(t.question)},className:"[&>p]:inline [&>p]:m-0"})]}),!t.isCorrect&&t.question.type==="multiple_choice"&&e.jsxs("div",{className:"text-sm text-green-400 flex flex-wrap gap-1",children:[e.jsx("span",{children:i==="ru"?"Правильный ответ: ":"Ҷавоби дуруст: "}),e.jsx("span",{className:"font-semibold",dangerouslySetInnerHTML:{__html:M(t.question.options.find(a=>a.id===t.question.correctId))}})]})]})]})},t.question.id))}),e.jsxs("div",{className:"p-6 border-t border-white/10 flex gap-4 justify-center",children:[e.jsxs("button",{onClick:ae,className:"flex items-center gap-2 px-6 py-3 bg-white/10 text-white rounded-xl hover:bg-white/20",children:[e.jsx(de,{size:18}),i==="ru"?"Пройти заново":"Аз нав"]}),j.isPassed&&e.jsxs("button",{onClick:()=>{V&&V(j),S()},className:"flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 shadow-[0_0_15px_rgba(22,163,74,0.5)]",children:[e.jsx(F,{size:18}),i==="ru"?"Забрать награду":"Гирифтани мукофот"]})]})]})}):e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 select-none",onContextMenu:t=>t.preventDefault(),style:{WebkitTouchCallout:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",userSelect:"none"},children:[!K&&e.jsx("div",{className:"fixed inset-0 z-[100] backdrop-blur-3xl flex items-center justify-center bg-black/90 cursor-not-allowed",onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx(z,{size:64,className:"mx-auto mb-4 text-red-500 animate-pulse"}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-2",children:i==="ru"?"Вернитесь к тесту!":"Ба тест баргардед!"}),e.jsx("p",{className:"text-white/80",children:i==="ru"?"Контент скрыт при потере фокуса":"Мундариҷа ҳангоми гум кардани фокус пинҳон карда мешавад"})]})}),e.jsxs("div",{className:`w-full max-w-2xl bg-gaming-card/95 rounded-3xl border border-white/10 overflow-hidden relative transition-all duration-300 flex flex-col max-h-[90vh] ${K?"":"opacity-0 pointer-events-none"}`,children:[e.jsx("div",{className:"absolute inset-0 z-0 pointer-events-none overflow-hidden opacity-[0.03] flex flex-wrap content-center justify-center gap-8 rotate-12 scale-150",children:Array.from({length:20}).map((t,s)=>e.jsx("div",{className:"text-2xl font-black text-white whitespace-nowrap",children:"DONISHMAND PLATFORM"},s))}),e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-white/10 relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"text-lg font-semibold",children:[i==="ru"?"Вопрос":"Савол"," ",g+1," / ",y]}),e.jsx("div",{className:"flex gap-1",children:p.map((t,s)=>{const a=(()=>{const d=x[t==null?void 0:t.id];return d==null||d===""?!1:(t==null?void 0:t.type)==="matching"&&typeof d=="object"?Object.keys(d).length>=t.leftItems.length:!0})(),r=_&&!a;return e.jsx("button",{onClick:()=>k(s),title:`${i==="ru"?"Вопрос":"Савол"} ${s+1}${a?"":i==="ru"?" (нет ответа)":" (ҷавоб нест)"}`,className:`w-2.5 h-2.5 rounded-full transition-all duration-300 cursor-pointer hover:scale-150 ${s===g?"bg-gaming-primary scale-125":a?"bg-white/60":r?"bg-red-500 animate-pulse scale-125":"bg-white/20 hover:bg-white/40"}`},s)})})]}),e.jsx("button",{onClick:S,className:"p-2 text-gaming-textMuted hover:text-white",children:e.jsx(me,{size:24})})]}),e.jsxs("div",{className:"p-6 relative z-10 overflow-y-auto flex-1",children:[e.jsx("div",{className:"text-xl font-medium mb-6 prose prose-invert max-w-none [&>p]:inline [&>p]:m-0",dangerouslySetInnerHTML:{__html:G(l)}}),l.image&&e.jsx("div",{className:"mb-6 rounded-xl overflow-hidden border border-white/10 bg-black/20 flex justify-center",children:e.jsx("img",{src:l.image,alt:"Question",className:"max-w-full max-h-[400px] object-contain"})}),l.type==="multiple_choice"&&(()=>{const t=C(l.id);return e.jsxs("div",{className:"space-y-3",children:[t&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-white/5 rounded-lg text-sm text-gaming-textMuted",children:[e.jsx(P,{size:14}),e.jsx("span",{children:i==="ru"?"Ответ зафиксирован":"Ҷавоб қайд шуд"})]}),l.options.map((s,a)=>{const r=x[l.id]===s.id;return e.jsxs("button",{onClick:()=>Q(l.id,s.id),disabled:t,className:`w-full flex items-center gap-4 p-4 rounded-xl border transition-all text-left ${r?"bg-gaming-primary/20 border-gaming-primary":t?"bg-white/5 border-white/5 opacity-40 cursor-not-allowed":"bg-white/5 border-white/10 hover:bg-white/10"}`,children:[e.jsx("span",{className:`w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0 ${r?"bg-gaming-primary text-white":"bg-white/10"}`,children:String.fromCharCode(65+a)}),e.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[e.jsx("span",{dangerouslySetInnerHTML:{__html:M(s)}}),s.image&&e.jsx("div",{className:"rounded-lg overflow-hidden border border-white/10 bg-black/20 max-w-[200px]",children:e.jsx("img",{src:s.image,alt:"Option",className:"w-full h-auto object-cover"})})]}),r&&t&&e.jsx(P,{size:16,className:"text-gaming-textMuted shrink-0"})]},s.id)})]})})(),l.type==="matching"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 pb-4 border-b border-white/10",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-bold text-gaming-pink uppercase tracking-wider mb-2",children:i==="ru"?"Группа 1":"Гурӯҳи 1"}),l.leftItems.map((t,s)=>e.jsxs("div",{className:"text-sm flex gap-2 items-baseline",children:[e.jsxs("span",{className:"font-bold text-gaming-pink min-w-[20px]",children:[String.fromCharCode(65+s),")"]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-gaming-textMuted leading-tight",dangerouslySetInnerHTML:{__html:M(t)}}),t.image&&e.jsx("img",{src:t.image,alt:"Item",className:"w-24 h-24 object-cover rounded-lg border border-white/10"})]})]},t.id))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-bold text-gaming-accent uppercase tracking-wider mb-2",children:i==="ru"?"Группа 2":"Гурӯҳи 2"}),l.rightItems.map((t,s)=>e.jsxs("div",{className:"text-sm flex gap-2 items-baseline",children:[e.jsxs("span",{className:"font-bold text-gaming-accent min-w-[20px]",children:[s+1,")"]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-gaming-textMuted leading-tight",dangerouslySetInnerHTML:{__html:M(t)}}),t.image&&e.jsx("img",{src:t.image,alt:"Item",className:"w-24 h-24 object-cover rounded-lg border border-white/10"})]})]},t.id))]})]}),e.jsx("p",{className:"text-sm text-gaming-textMuted text-center",children:i==="ru"?"Выберите соответствия в сетке:":"Мувофиқатро дар ҷадвал интихоб кунед:"}),e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"overflow-x-auto max-w-full pb-2",children:e.jsxs("table",{className:"border-separate border-spacing-1",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-8"}),l.rightItems.map((t,s)=>e.jsx("th",{className:"text-center font-bold text-gaming-accent text-sm p-1",children:s+1},t.id))]})}),e.jsx("tbody",{children:l.leftItems.map((t,s)=>e.jsxs("tr",{children:[e.jsx("td",{className:"text-center font-bold text-gaming-pink text-sm p-1",children:String.fromCharCode(65+s)}),l.rightItems.map(a=>{var o;const r=((o=x[l.id])==null?void 0:o[t.id])===a.id,d=C(l.id);return e.jsx("td",{className:"text-center p-0.5",children:e.jsx("button",{onClick:()=>Q(l.id,{...x[l.id]||{},[t.id]:a.id}),disabled:d,className:`w-8 h-8 rounded-full border-2 transition-all flex items-center justify-center
                                                                        ${r?"bg-gaming-primary border-gaming-primary":d?"bg-white/5 border-white/10 opacity-30 cursor-not-allowed":"bg-white/5 border-white/20 hover:border-white/40"}`,children:r&&e.jsx("div",{className:"w-3 h-3 bg-white rounded-full"})})},a.id)})]},t.id))})]})})})]}),l.type==="numeric"&&(()=>{const t=C(l.id);return e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gaming-textMuted",children:t?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(P,{size:14})," ",i==="ru"?"Ответ зафиксирован":"Ҷавоб қайд шуд"]}):i==="ru"?"Введите ответ:":"Ҷавобро ворид кунед:"}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[[0,1,2,3].map(s=>e.jsx("input",{type:"text",maxLength:1,disabled:t,value:(x[l.id]||"")[s]||"",onChange:a=>{const r=a.target.value;if(r&&!/^\d$/.test(r))return;const o=(x[l.id]||"").split("");if(o[s]=r,Q(l.id,o.join("")),r&&s<3){const w=a.target.nextElementSibling;w&&w.focus()}},className:`w-14 h-14 text-center text-2xl font-bold rounded-lg text-white focus:outline-none ${t?"bg-gaming-bg/50 border-2 border-gaming-primary/30 opacity-70 cursor-not-allowed":"bg-gaming-bg/50 border-2 border-white/20 focus:border-gaming-primary"}`},s)),l.unit&&e.jsx("span",{className:"text-xl text-gaming-textMuted ml-2",children:l.unit})]})]})})()]}),e.jsxs("div",{className:"flex items-center justify-between p-4 border-t border-white/10 relative z-10",children:[g>0?e.jsxs("button",{onClick:ie,className:"flex items-center gap-2 px-4 py-2 rounded-xl text-white hover:bg-white/10",children:[e.jsx(xe,{size:18}),i==="ru"?"Назад":"Қафо"]}):e.jsx("div",{}),g===y-1?e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[_&&W&&e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-red-500/20 border border-red-500/40 text-red-400 rounded-xl text-sm animate-bounce",children:[e.jsx(ue,{size:16,className:"shrink-0"}),e.jsx("span",{children:W})]}),e.jsxs("button",{onClick:ne,className:`flex items-center gap-2 px-6 py-2 rounded-xl transition-all ${_?"bg-red-500/80 text-white animate-[shake_0.5s_ease-in-out]":"bg-gaming-primary text-white hover:bg-gaming-primary/80"}`,children:[e.jsx(F,{size:18}),i==="ru"?"Завершить тест":"Тамом кардан"]})]}):e.jsxs("button",{onClick:re,className:"flex items-center gap-2 px-4 py-2 text-white hover:bg-white/10 rounded-xl",children:[i==="ru"?"Далее":"Оянда",e.jsx(he,{size:18})]})]})]})]})};export{Se as default};
