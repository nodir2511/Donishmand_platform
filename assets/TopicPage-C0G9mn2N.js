import{j as t}from"./editor-y_DXvsmM.js";import{f as C,u as L,r as y,L as A}from"./vendor-DfgOC3sD.js";import{C as M}from"./CourseLayout-Buqr-hqM.js";import{u as E}from"./SyllabusContext-BwXa2ym8.js";import{u as I,s as S}from"./index-BX-jT5UU.js";import{u as R,k as $,n as z,F as _,P,A as F}from"./ui-DqTeed5j.js";import"./supabase-CQnWzhEg.js";const k="donishmand_topic_stats",T=()=>{try{const s=localStorage.getItem(k);return s?JSON.parse(s):{}}catch{return{}}},O=s=>{try{const c={...T(),...s};localStorage.setItem(k,JSON.stringify(c))}catch{}},q=s=>{const r={};for(const a of s)r[a.lesson_id]||(r[a.lesson_id]=[]),r[a.lesson_id].push(a);const c={};for(const[a,l]of Object.entries(r)){const p=l.length,d=Math.max(...l.map(n=>n.score)),x=l.reduce((n,m)=>n+m.score,0)/p,o=Math.round(100-x),i=Math.max(...l.map(n=>new Date(n.created_at).getTime()));c[a]={totalAttempts:p,bestScore:d,avgErrorRate:o,avgScore:x,lastAttemptAt:i}}return c},J=({subjectId:s,sectionId:r,topicId:c,isTeacher:a,navigate:l,lessonStats:p})=>{const{t:d,i18n:x}=R(),o=x.resolvedLanguage||"ru",{subjectData:i,loading:n}=E();if(n)return t.jsx("div",{className:"flex items-center justify-center min-h-[40vh]",children:t.jsx($,{size:40,className:"text-gaming-primary animate-spin"})});const m=i==null?void 0:i.sections.find(e=>e.id===r),u=(i==null?void 0:i.sections.findIndex(e=>e.id===r))??-1,g=m==null?void 0:m.topics.find(e=>e.id===c),b=(m==null?void 0:m.topics.findIndex(e=>e.id===c))??-1;if(!g)return t.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[40vh] text-white",children:[t.jsx("h2",{className:"text-2xl mb-4",children:d("topicNotFound")}),t.jsx("button",{onClick:()=>l(`/subject/${s}/section/${r}`),className:"text-gaming-primary hover:underline",children:d("backToSection")})]});const f=e=>o==="tj"&&e.titleTj?e.titleTj:e.title,v=(()=>{const e=g.lessons.map(N=>N.id);let h=0,j=0;for(const N of e){const w=p[N];w&&(h++,j+=w.avgScore)}return h===0?null:{completedLessons:h,totalLessons:e.length,avgErrorRate:Math.round(100-j/h)}})();return t.jsxs("div",{className:"max-w-5xl",children:[t.jsxs("h1",{className:"text-3xl font-bold mb-2 text-gaming-accent",children:[u+1,".",b+1,". ",f(g)]}),t.jsxs("div",{className:"flex items-center gap-4 mb-8",children:[t.jsxs("button",{onClick:()=>l(`/subject/${s}/section/${r}`),className:"flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-gaming-textMuted hover:text-white transition-all group w-fit",children:[t.jsx(z,{size:18,className:"group-hover:-translate-x-1 transition-transform"}),t.jsx("span",{className:"text-sm font-medium",children:d("backToSection")})]}),t.jsxs("p",{className:"text-gaming-textMuted",children:[g.lessons.length," ",d("lessonsCount")]})]}),v&&!a&&t.jsxs("div",{className:"mb-8 p-6 bg-gradient-to-r from-gaming-primary/10 to-gaming-purple/10 rounded-2xl border border-white/5 flex items-center gap-6",children:[t.jsx("div",{className:"p-4 bg-gaming-primary/20 rounded-full text-gaming-primary",children:t.jsx(_,{size:32})}),t.jsxs("div",{children:[t.jsxs("div",{className:"text-3xl font-bold text-white mb-1",children:[v.avgErrorRate,"%"]}),t.jsx("div",{className:"text-gaming-textMuted text-sm",children:o==="ru"?"Средний % ошибок по теме":"Миёна % хатогиҳо дар мавзӯъ"}),t.jsx("div",{className:"text-xs text-gaming-textMuted mt-1 opacity-70",children:o==="ru"?`На основе ${v.completedLessons} пройденных уроков`:`Дар асоси ${v.completedLessons} дарсҳои гузашта`})]})]}),t.jsx("div",{className:"space-y-4",children:g.lessons.map((e,h)=>{const j=p[e.id]||null;return t.jsxs(A,{to:`/lesson/${e.id}`,className:"group flex items-center gap-4 bg-gaming-card/40 backdrop-blur-xl border border-white/5 p-5 rounded-2xl hover:border-gaming-pink/50 transition-all duration-300 hover:bg-gaming-card/60",children:[t.jsx("div",{className:"w-12 h-12 rounded-xl bg-gaming-pink/10 flex items-center justify-center text-gaming-pink group-hover:scale-110 transition-transform",children:e.type==="video"?t.jsx(P,{size:24}):t.jsx(_,{size:24})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("h3",{className:"text-lg font-bold group-hover:text-gaming-pink transition-colors truncate",children:[h+1,". ",f(e)]}),t.jsx("span",{className:"uppercase text-[10px] font-bold bg-white/5 border border-white/10 px-2 py-0.5 rounded text-gaming-textMuted tracking-wider",children:e.type==="video"?"видео":o==="ru"?"текст":"матн"})]}),j&&!a&&t.jsxs("div",{className:"mr-2 text-right",children:[t.jsxs("div",{className:"text-xl font-bold text-white leading-none",children:[j.avgErrorRate,"%"]}),t.jsx("div",{className:"text-[10px] text-gaming-textMuted uppercase tracking-wider opacity-70",children:o==="ru"?"ошибок":"хато"})]}),t.jsx(F,{className:"text-white/20 group-hover:text-gaming-pink transition-colors shrink-0"})]},e.id)})})]})},V=()=>{const{subjectId:s,sectionId:r,topicId:c}=C(),a=L(),{isTeacher:l,isAdmin:p,profile:d}=I(),x=l||p,[o,i]=y.useState(()=>T());return y.useEffect(()=>{if(x||!d)return;let n=!1;return(async()=>{try{const{data:{user:u}}=await S.auth.getUser();if(!(u!=null&&u.id)||n)return;const{data:g,error:b}=await S.from("user_test_results").select("lesson_id, score, correct_count, total_questions, is_passed, created_at").eq("user_id",u.id);if(b||!g||n)return;const f=q(g);n||(i(f),O(f))}catch(u){console.error("Ошибка загрузки статистики темы:",u)}})(),()=>{n=!0}},[d,x]),t.jsx(M,{subjectId:s,children:t.jsx(J,{subjectId:s,sectionId:r,topicId:c,isTeacher:x,navigate:a,lessonStats:o})})};export{V as default};
