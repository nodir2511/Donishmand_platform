import{s as w}from"./index-DtKwPHMP.js";const E=t=>{var n,g,o,r,R,T,I;if(!t)return{contentRu:null,contentTj:null};const u=h=>{if(!h||!Array.isArray(h))return{ru:[],tj:[]};const d=h.map(e=>{const l={id:e.id,type:e.type,image:e.imageRu||e.image};return l.text=e.textRu||"",e.type==="multiple_choice"?(l.options=(e.options||[]).map(s=>({id:s.id,text:s.textRu||"",image:s.imageRu||s.image})),l.correctId=e.correctId):e.type==="matching"?(l.leftItems=(e.leftItems||[]).map(s=>({id:s.id,text:s.textRu||"",image:s.imageRu||s.image})),l.rightItems=(e.rightItems||[]).map(s=>({id:s.id,text:s.textRu||"",image:s.imageRu||s.image})),l.correctMatches=e.correctMatches):e.type==="numeric"&&(l.digits=e.digits,l.unit=e.unit),l}),f=h.map(e=>{const l={id:e.id,type:e.type,image:e.imageTj||e.imageRu||e.image};return l.text=e.textTj||"",e.type==="multiple_choice"?(l.options=(e.options||[]).map(s=>({id:s.id,text:s.textTj||"",image:s.imageTj||s.imageRu||s.image})),l.correctId=e.correctId):e.type==="matching"?(l.leftItems=(e.leftItems||[]).map(s=>({id:s.id,text:s.textTj||"",image:s.imageTj||s.imageRu||s.image})),l.rightItems=(e.rightItems||[]).map(s=>({id:s.id,text:s.textTj||"",image:s.imageTj||s.imageRu||s.image})),l.correctMatches=e.correctMatches):e.type==="numeric"&&(l.digits=e.digits,l.unit=e.unit),l});return{ru:d,tj:f}},{ru:i,tj:a}=u((n=t.test)==null?void 0:n.questions);return{contentRu:{video:{url:((g=t.video)==null?void 0:g.url)||"",description:((o=t.video)==null?void 0:o.descriptionRu)||""},text:{body:((r=t.text)==null?void 0:r.bodyRu)||""},test:{questions:i},slides:t.slidesRu||[]},contentTj:{video:{url:((R=t.video)==null?void 0:R.urlTj)||"",description:((T=t.video)==null?void 0:T.descriptionTj)||""},text:{body:((I=t.text)==null?void 0:I.bodyTj)||""},test:{questions:a},slides:t.slidesTj||[]}}},G=(t,u)=>{var T,I,h,d,f,e,l,s,A,Q,D,L;const i=p=>p?p.toString().replace(/<[^>]*>?/gm,"").replace(/&nbsp;/g," ").trim():"",a=p=>{const j=i(p);return j!==""&&/^\d+$/.test(j)},n=p=>{if(!p)return"";const j=[p.question,p.text,p.title];for(const c of j)if(c&&!a(c))return c;return""},g=p=>!p||!Array.isArray(p)?p:p.map(j=>{const c={...j};if(c.textRu||(c.textRu=n(j)),!c.textTj){const m=[j.textTj,j.question,j.text,j.title];for(const x of m)if(x&&!a(x)&&x!==c.textRu){c.textTj=x;break}}return c.options&&(c.options=c.options.map(m=>({...m,textRu:m.textRu?m.textRu:n(m),textTj:m.textTj||""}))),c.leftItems&&(c.leftItems=c.leftItems.map(m=>({...m,textRu:m.textRu?m.textRu:n(m),textTj:m.textTj||""}))),c.rightItems&&(c.rightItems=c.rightItems.map(m=>({...m,textRu:m.textRu?m.textRu:n(m),textTj:m.textTj||""}))),c});if(t&&(t.slidesRu||(T=t.text)!=null&&T.bodyRu))return(I=t.test)!=null&&I.questions?{...t,test:{...t.test,questions:g(t.test.questions)}}:t;const o=t||{},r=u||{};console.log("[DEBUG mergeContent] ru.test?.questions:",JSON.stringify((h=o.test)==null?void 0:h.questions,null,2)),console.log("[DEBUG mergeContent] tj.test?.questions:",JSON.stringify((d=r.test)==null?void 0:d.questions,null,2));const R=(p,j)=>{const c=p||[],m=j||[];return c.map((x,B)=>{const C=m[B]||{},_={id:x.id,type:x.type,imageRu:x.image,imageTj:C.image,textRu:x.text||"",textTj:C.text||""};return x.type==="multiple_choice"?(_.options=(x.options||[]).map((y,M)=>{var b;const v=((b=C.options)==null?void 0:b[M])||{};return{id:y.id,imageRu:y.image,imageTj:v.image,textRu:y.text||"",textTj:v.text||""}}),_.correctId=x.correctId):x.type==="matching"?(_.leftItems=(x.leftItems||[]).map((y,M)=>{var b;const v=((b=C.leftItems)==null?void 0:b[M])||{};return{id:y.id,imageRu:y.image,imageTj:v.image,textRu:y.text||"",textTj:v.text||""}}),_.rightItems=(x.rightItems||[]).map((y,M)=>{var b;const v=((b=C.rightItems)==null?void 0:b[M])||{};return{id:y.id,imageRu:y.image,imageTj:v.image,textRu:y.text||"",textTj:v.text||""}}),_.correctMatches=x.correctMatches):x.type==="numeric"&&(_.digits=x.digits,_.unit=x.unit),_})};return{video:{url:((f=o.video)==null?void 0:f.url)||"",urlTj:((e=r.video)==null?void 0:e.url)||"",descriptionRu:((l=o.video)==null?void 0:l.description)||"",descriptionTj:((s=r.video)==null?void 0:s.description)||""},text:{bodyRu:((A=o.text)==null?void 0:A.body)||"",bodyTj:((Q=r.text)==null?void 0:Q.body)||""},test:{questions:R((D=o.test)==null?void 0:D.questions,(L=r.test)==null?void 0:L.questions)},slidesRu:o.slides||[],slidesTj:r.slides||[]}},S={structures:{},lessons:{}},k={invalidateCache(t){t?delete S.structures[t]:(S.structures={},S.lessons={})},async saveStructure(t,u){const i=u.sections.map(n=>({id:n.id,title:n.title,titleTj:n.titleTj,topics:n.topics.map(g=>({id:g.id,title:g.title,titleTj:g.titleTj,lessons:g.lessons.map(o=>({id:o.id,title:o.title,titleTj:o.titleTj,type:o.type}))}))})),{error:a}=await w.from("subject_syllabus").upsert({subject:t,data:{sections:i},updated_at:new Date},{onConflict:"subject"});if(a)throw console.error("Ошибка сохранения структуры:",a),a;return!0},async getStructure(t){if(!t||t==="undefined"||t==="null")return null;if(S.structures[t])return S.structures[t];const{data:u,error:i}=await w.from("subject_syllabus").select("data").eq("subject",t).maybeSingle();if(i)throw i;return u?(S.structures[t]=u.data,u.data):null},async saveLesson(t,u){const{contentRu:i,contentTj:a}=E(t.content),n=r=>Array.isArray(r)?r.map(n):r instanceof Date?r:r!==null&&typeof r=="object"?Object.fromEntries(Object.entries(r).filter(([R,T])=>T!==void 0).map(([R,T])=>[R,n(T)])):r,g=n({id:t.id,title_ru:t.title,title_tj:t.titleTj,subject:u,content_ru:i,content_tj:a,is_published:!0,updated_at:new Date}),{error:o}=await w.from("lessons").upsert(g,{onConflict:"id"});if(o)throw o;return!0},async deleteLesson(t){const{error:u}=await w.from("lessons").delete().eq("id",t);if(u)throw u;return!0},async deleteLessons(t){if(!t||t.length===0)return!0;const{error:u}=await w.from("lessons").delete().in("id",t);if(u)throw u;return!0},async getLesson(t,u=null){var o;const i=u==="ru"?"id, title_ru, title_tj, subject, content_ru":u==="tj"?"id, title_ru, title_tj, subject, content_tj":"*",{data:a,error:n}=await w.from("lessons").select(i).eq("id",t).single();if(n){if(n.code==="PGRST116")return null;throw n}let g;if(u){const r=u==="ru"?a.content_ru:a.content_tj;r&&(r.slidesRu||(o=r.text)!=null&&o.bodyRu)?g=r:g=N(r,u)}else g=G(a.content_ru,a.content_tj);return{id:a.id,title:a.title_ru,titleTj:a.title_tj,content:g,subject:a.subject}}},N=(t,u)=>{var n,g,o,r,R,T,I;if(!t)return{video:{url:"",urlTj:"",descriptionRu:"",descriptionTj:""},text:{bodyRu:"",bodyTj:""},test:{questions:[]},slidesRu:[],slidesTj:[]};const i=u==="ru",a=h=>(h||[]).map(d=>{const f={id:d.id,type:d.type,imageRu:i&&d.image||null,imageTj:i?null:d.image||null,textRu:i&&d.text||"",textTj:i?"":d.text||""};return d.type==="multiple_choice"?(f.options=(d.options||[]).map(e=>({id:e.id,imageRu:i&&e.image||null,imageTj:i?null:e.image||null,textRu:i&&e.text||"",textTj:i?"":e.text||""})),f.correctId=d.correctId):d.type==="matching"?(f.leftItems=(d.leftItems||[]).map(e=>({id:e.id,imageRu:i&&e.image||null,imageTj:i?null:e.image||null,textRu:i&&e.text||"",textTj:i?"":e.text||""})),f.rightItems=(d.rightItems||[]).map(e=>({id:e.id,imageRu:i&&e.image||null,imageTj:i?null:e.image||null,textRu:i&&e.text||"",textTj:i?"":e.text||""})),f.correctMatches=d.correctMatches):d.type==="numeric"&&(f.digits=d.digits,f.unit=d.unit),f});return{video:{url:i&&((n=t.video)==null?void 0:n.url)||"",urlTj:i?"":((g=t.video)==null?void 0:g.url)||"",descriptionRu:i&&((o=t.video)==null?void 0:o.description)||"",descriptionTj:i?"":((r=t.video)==null?void 0:r.description)||""},text:{bodyRu:i&&((R=t.text)==null?void 0:R.body)||"",bodyTj:i?"":((T=t.text)==null?void 0:T.body)||""},test:{questions:a((I=t.test)==null?void 0:I.questions)},slidesRu:i?t.slides||[]:[],slidesTj:i?[]:t.slides||[]}};export{k as s};
